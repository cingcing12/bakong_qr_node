<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sokpheak POS</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<style>
body{font-family:sans-serif;display:flex;justify-content:center;align-items:center;height:100vh;background:#f3f4f6;margin:0}
.card{background:#fff;padding:40px;border-radius:20px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.1);width:320px}
.amount{font-size:3rem;font-weight:800;color:#E60000;margin:10px 0}
#qrcode{margin:20px auto;display:flex;justify-content:center}
.status{margin-top:20px;font-weight:600;color:#6b7280;display:flex;justify-content:center;align-items:center;gap:10px}
.loader{width:15px;height:15px;border:2px solid #ccc;border-top-color:#333;border-radius:50%;animation:spin 1s infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div class="card">
  <h2>KHQR Pay</h2>
  <div class="amount">500 ៛</div>
  <div id="qrcode"></div>
  <div class="status" id="statusText"><div class="loader"></div> Waiting for payment...</div>
  <p style="font-size:10px;color:#ccc;margin-top:20px">Hash: <span id="hashDisplay">...</span></p>
</div>

<script>
const API_URL = "http://localhost:3000"; // Change to your backend URL
const socket = io(API_URL, { transports:["polling","websocket"], reconnection:true });

let currentHash="", pollTimer=null, expireTimer=null, paid=false;

init();

async function init(){
  reset();
  try {
    const res = await fetch(`${API_URL}/api/generate-qr`, { method:"POST" });
    const data = await res.json();

    renderQR(data.qrString);
    currentHash = data.md5;
    document.getElementById("hashDisplay").innerText = currentHash;

    socket.emit("join-payment", currentHash);

    // Auto open Bakong on mobile if deeplink
    if (/Android|iPhone/i.test(navigator.userAgent) && data.deeplink){
      window.location.href = data.deeplink;
    }

    startPolling(currentHash);
    startExpireCountdown(data.expireTime);
  } catch(err){ showError("Cannot generate QR"); console.error(err); }
}

function renderQR(qrString){
  const qr = qrcode(0,"M");
  qr.addData(qrString);
  qr.make();
  document.getElementById("qrcode").innerHTML = qr.createImgTag(5);
}

function startPolling(md5){
  pollTimer = setInterval(async()=>{
    if(paid) return;
    try{
      const r = await fetch(`${API_URL}/api/check-status`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ md5 })
      });
      const d = await r.json();
      if(d.status==="success") handleSuccess();
    }catch{}
  },2000);
}

function startExpireCountdown(expireTime){
  const remaining = expireTime - Date.now();
  if(remaining<=0) return;
  expireTimer = setTimeout(()=>{ if(!paid){ showError("QR Expired"); setTimeout(init,1500); }}, remaining);
}

function handleSuccess(){
  if(paid) return;
  paid=true;
  clearInterval(pollTimer); clearTimeout(expireTimer);
  document.getElementById("statusText").innerHTML="✅ Payment Successful";
  Swal.fire({icon:"success",title:"Payment Completed",text:"Thank you!",timer:2000,showConfirmButton:false});
}

function reset(){
  paid=false; clearInterval(pollTimer); clearTimeout(expireTimer);
  document.getElementById("qrcode").innerHTML="";
  document.getElementById("hashDisplay").innerText="...";
  document.getElementById("statusText").innerHTML='<div class="loader"></div> Waiting for payment...';
}

function showError(msg){
  document.getElementById("statusText").innerHTML="❌ "+msg;
  document.getElementById("statusText").style.color="red";
}

socket.on("payment-success", (data)=>{
  if(data.md5===currentHash) handleSuccess();
});
</script>

</body>
</html>
